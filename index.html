<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ne buket</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --mint:#A7CEBB;         /* —Ñ–æ–Ω –∫–∞–∫ –Ω–∞ —Ä–µ—Ñ–µ */
      --ink:#060A07;          /* –ø–æ—á—Ç–∏ —á—ë—Ä–Ω—ã–π */
      --red:#DF3A2C;          /* —Å–ª—ç—à */
      --soft:#F6F6F6;
      --line:#EAEAEA;
      --muted:#6E6E6E;
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#fff;
      color:var(--ink);
    }

    /* Layout */
    .app{min-height:100vh; padding-bottom:78px;}
    .content{padding:14px 14px 24px;}
    .hidden{display:none !important;}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:var(--mint);
      padding:14px 12px 10px;
      border-bottom:1px solid rgba(0,0,0,.06);
      overflow:hidden;
    }
    .topbar-grid{
      display:grid;
      grid-template-columns: 88px 1fr 44px;
      align-items:center;
      gap:8px;
    }
    .ghost{
      background:transparent;
      border:0;
      font-size:16px;
      color:var(--ink);
      padding:8px 10px;
      border-radius:12px;
    }
    .ghost:active{background:rgba(255,255,255,.25)}
    .brandwrap{ text-align:center; line-height:1.05; }
    .brand{
      font-weight:900;
      letter-spacing:-.6px;
      font-size:22px;
      text-transform:lowercase;
    }
    .sub{
      margin-top:4px;
      font-size:12px;
      color:rgba(0,0,0,.55);
      font-weight:700;
    }

    /* Signature slash */
    .slash{
      position:absolute;
      left:-20%;
      top:44px;
      width:140%;
      height:12px;
      background:var(--red);
      transform:rotate(-18deg);
      transform-origin:center;
      opacity:.95;
      filter:saturate(1.05);
      animation:slashIn .55s ease-out both;
    }
    @keyframes slashIn{
      from{ transform:translateY(-10px) rotate(-18deg); opacity:0; }
      to{ transform:translateY(0) rotate(-18deg); opacity:.95; }
    }

    /* Bottom nav */
    .bottomnav{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      background:#fff;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:space-around;
      padding:10px 8px 12px;
    }
    .tab{
      width:25%;
      text-decoration:none;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size:18px;
      padding:6px 0;
      position:relative;
      user-select:none;
    }
    .tab span{font-size:12px; font-weight:700}
    .tab.active{color:var(--ink)}
    .tab.active::after{
      content:"";
      position:absolute;
      bottom:2px;
      width:36px;
      height:4px;
      background:var(--red);
      border-radius:999px;
      transform:rotate(-10deg);
    }

    .badge{
      position:absolute;
      top:2px;
      right:28%;
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      background:var(--ink);
      color:#fff;
      font-size:12px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      transform:translate(10px,-6px);
    }
    .badge.hidden{display:none}

    /* Hero */
    .hero{
      margin:10px 0 14px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      background:#fff;
      position:relative;
      overflow:hidden;
    }
    .hero h1{
      margin:0;
      font-size:34px;
      letter-spacing:-1.2px;
      font-weight:950;
      text-transform:lowercase;
    }
    .hero p{
      margin:8px 0 0;
      color:var(--muted);
      font-weight:700;
      line-height:1.25;
    }
    .hero .stamp{
      margin-top:12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      border:1px solid rgba(0,0,0,.14);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      background:#fff;
      color:var(--ink);
    }
    .pill.red{
      border-color:var(--red);
      color:var(--red);
    }

    /* Chips */
    .chips{
      display:flex;
      gap:8px;
      overflow:auto;
      padding:2px 0 8px;
    }
    .chip{
      flex:0 0 auto;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.16);
      background:#fff;
      color:var(--ink);
      font-weight:900;
      font-size:13px;
      user-select:none;
    }
    .chip.on{
      border-color:var(--ink);
      box-shadow: inset 0 0 0 1px var(--ink);
    }
    .chip.small{
      font-weight:800;
      color:var(--muted);
      border-color:rgba(0,0,0,.10);
    }
    .chip.small.on{
      color:var(--ink);
      border-color:var(--ink);
      box-shadow: inset 0 0 0 1px var(--ink);
    }

    /* Grid cards */
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:8px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    .img{
      position:relative;
      aspect-ratio:1/1;
      background:linear-gradient(135deg, #fafafa, #eaeaea);
    }
    .img .ph{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:38px;
      font-weight:950;
      color:rgba(0,0,0,.75);
      letter-spacing:-2px;
      user-select:none;
    }
    .img .tag{
      position:absolute;
      top:10px; left:10px;
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      font-size:12px;
      font-weight:950;
    }
    .img .tag.red{
      border-color:var(--red);
      color:var(--red);
    }
    .img .cornerSlash{
      position:absolute;
      right:-22px;
      bottom:18px;
      width:90px;
      height:10px;
      background:var(--red);
      transform:rotate(-25deg);
      opacity:.9;
    }
    .img .cartBtn{
      position:absolute;
      right:10px;
      bottom:10px;
      width:36px;
      height:36px;
      border-radius:50%;
      border:0;
      background:rgba(0,0,0,.55);
      color:#fff;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .img .cartBtn:active{transform:scale(.96)}

    .body{
      padding:10px 10px 12px;
    }
    .title{
      font-weight:950;
      font-size:14px;
      letter-spacing:-.2px;
      margin:0 0 8px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .price{
      font-weight:950;
      letter-spacing:-.3px;
    }
    .qty{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:950;
    }
    .qty button{
      width:28px;height:28px;
      border-radius:50%;
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      font-size:18px;
      cursor:pointer;
    }
    .qty button:disabled{opacity:.35; cursor:default}
    .qty span{min-width:18px; text-align:center}

    /* Cart */
    .h2{
      font-size:22px;
      font-weight:950;
      letter-spacing:-.6px;
      margin:6px 0 12px;
      text-transform:lowercase;
    }

    .empty{
      min-height:58vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .panel{
      width:min(420px, 100%);
      background:var(--soft);
      border:1px solid var(--line);
      border-radius:22px;
      padding:22px;
      text-align:center;
    }
    .panel .x{
      font-size:28px;
      font-weight:950;
      margin-bottom:8px;
    }
    .panel .t{
      font-size:20px;
      font-weight:950;
      margin-bottom:8px;
    }
    .panel .p{
      color:var(--muted);
      font-weight:700;
      margin-bottom:14px;
      line-height:1.25;
    }
    .btn{
      width:80%;
      padding:14px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      font-weight:950;
      cursor:pointer;
    }
    .btn.red{
      border-color:var(--red);
      color:#fff;
      background:var(--red);
    }
    .btn:active{transform:scale(.99)}

    .cartList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .cartItem{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:#fff;
    }
    .cartLeft{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .cartName{
      font-weight:950;
      letter-spacing:-.2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:220px;
    }
    .cartMeta{
      color:var(--muted);
      font-weight:700;
      font-size:13px;
    }
    .bar{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .total{
      font-weight:950;
      font-size:16px;
    }
    .clear{
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:950;
      cursor:pointer;
    }

    /* Profile */
    .profileTop{
      display:flex;
      align-items:center;
      gap:12px;
      margin:8px 0 14px;
    }
    .avatar{
      width:54px;height:54px;
      border-radius:50%;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background:linear-gradient(135deg, #fafafa, #e6e6e6);
      display:flex;align-items:center;justify-content:center;
      font-weight:950;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .name{
      font-size:22px;
      font-weight:950;
      letter-spacing:-.5px;
      line-height:1.05;
    }
    .box{
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--soft);
      padding:14px;
      margin-bottom:12px;
    }
    .box .bh{
      font-weight:950;
      margin-bottom:6px;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin:12px 0 18px;
    }
    .item{
      font-weight:900;
      font-size:16px;
    }

    /* How */
    .how h3{
      margin:12px 0 8px;
      font-size:16px;
      font-weight:950;
      letter-spacing:-.2px;
    }
    .how p{
      margin:0 0 10px;
      color:var(--muted);
      font-weight:700;
      line-height:1.25;
    }
    .tile{
      display:flex;
      gap:12px;
      align-items:center;
      border:1px solid var(--line);
      background:var(--soft);
      border-radius:18px;
      padding:12px;
      margin-bottom:10px;
    }
    .ic{
      width:42px;height:42px;border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      display:flex;align-items:center;justify-content:center;
      font-size:20px;
    }
    .tile .tt{font-weight:950}
    .tile .mm{color:var(--muted); font-weight:700; font-size:13px; margin-top:2px}

    /* Small screens niceties */
    @media (max-width:360px){
      .grid{grid-template-columns:1fr}
      .cartName{max-width:160px}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="slash" aria-hidden="true"></div>

      <div class="topbar-grid">
        <button class="ghost" id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div class="brandwrap">
          <div class="brand">ne buket</div>
          <div class="sub">–Ω–µ –∫–ª–∏—à–µ. –Ω–µ –ø–∞—Ñ–æ—Å.</div>
        </div>
        <button class="ghost" id="dotsBtn" aria-label="menu">‚ãØ</button>
      </div>
    </div>

    <div class="content">

      <!-- CATALOG -->
      <section id="page-catalog">
        <div class="hero">
          <h1>ne buket</h1>
          <p>—Ü–≤–µ—Ç—ã –∫–∞–∫ —Å—Ç–∏–ª—å. –±–µ–∑ –ª–∏—à–Ω–µ–π –ª–∏—Ä–∏–∫–∏.</p>
          <div class="stamp">
            <div class="pill red">–Ω–µ –±–∞–Ω–∞–ª—å–Ω–æ</div>
            <div class="pill">–±—ã—Å—Ç—Ä–æ</div>
            <div class="pill">—á–µ—Å—Ç–Ω–æ</div>
          </div>
        </div>

        <div class="chips" id="cats"></div>
        <div class="chips" id="tags"></div>

        <div class="grid" id="grid"></div>
      </section>

      <!-- CART -->
      <section id="page-cart" class="hidden">
        <div class="h2">–∫–æ—Ä–∑–∏–Ω–∞</div>

        <div id="cartEmpty" class="empty">
          <div class="panel">
            <div class="x">ne-—á—Ç–æ –∫—É–ø–∏—Ç—å?</div>
            <div class="t">–∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è</div>
            <div class="p">–Ω–∞–∂–º–∏ ‚Äú+‚Äù —É —Ç–æ–≤–∞—Ä–∞. –æ–Ω —É–ª–µ—Ç–∏—Ç —Å—é–¥–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.</div>
            <button class="btn red" id="goCatalog">–≤ –∫–∞—Ç–∞–ª–æ–≥</button>
          </div>
        </div>

        <div id="cartFilled" class="hidden">
          <div class="cartList" id="cartList"></div>

          <div class="bar">
            <div class="total" id="cartTotal">–∏—Ç–æ–≥–æ: 0 ‚ÇΩ</div>
            <button class="clear" id="clearCart">–æ—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div style="margin-top:12px; display:flex; justify-content:center;">
            <button class="btn red" id="checkoutBtn">–æ—Ñ–æ—Ä–º–∏—Ç—å</button>
          </div>
          <div style="margin-top:10px; text-align:center; color:var(--muted); font-weight:700; font-size:12px;">
            (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞. –ø–æ—Ç–æ–º –ø–æ–¥–∫–ª—é—á–∏–º –æ–ø–ª–∞—Ç—É/–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ.)
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="page-profile" class="hidden">
        <div class="profileTop">
          <div class="avatar" id="avatar">NB</div>
          <div>
            <div class="name" id="username">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
            <div style="color:var(--muted); font-weight:800; margin-top:4px;">–∞–∫–∫–∞—É–Ω—Ç –∏–∑ Telegram</div>
          </div>
        </div>

        <div class="box">
          <div class="bh">–∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑</div>
          <div style="color:var(--muted); font-weight:700;">–ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
        </div>

        <div class="list">
          <div class="item">üìç –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</div>
          <div class="item">üßæ –∏—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
          <div class="item">üí¨ –ø–æ–¥–¥–µ—Ä–∂–∫–∞</div>
        </div>

        <div class="box">
          <div class="bh">–±–æ–Ω—É—Å—ã</div>
          <div style="font-size:34px; font-weight:950;">500</div>
          <div style="color:var(--muted); font-weight:700;">–±–∞–ª–ª–æ–≤ (–∑–∞–≥–ª—É—à–∫–∞)</div>
        </div>
      </section>

      <!-- HOW IT WORKS -->
      <section id="page-how" class="hidden how">
        <div class="h2">–∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>

        <div class="tile">
          <div class="ic">üïí</div>
          <div>
            <div class="tt">–±—ã—Å—Ç—Ä–æ</div>
            <div class="mm">—Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞. –±–µ–∑ —Å–æ–∑–≤–æ–Ω–æ–≤ –∏ ‚Äú–æ–π, —Å–µ–π—á–∞—Å —É—Ç–æ—á–Ω—é‚Äù.</div>
          </div>
        </div>

        <div class="tile">
          <div class="ic">üí∏</div>
          <div>
            <div class="tt">—á–µ—Å—Ç–Ω–æ</div>
            <div class="mm">—Ü–µ–Ω–∞ –ø–æ–Ω—è—Ç–Ω–∞—è. –±–µ–∑ —Ç–µ–∞—Ç—Ä–∞ –∏ ‚Äú—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–∑–∏—Ü–∏–π‚Äù.</div>
          </div>
        </div>

        <div class="tile">
          <div class="ic">üåø</div>
          <div>
            <div class="tt">–∂–∏–≤–æ–π —Ç–æ–≤–∞—Ä</div>
            <div class="mm">—Ü–≤–µ—Ç—ã –∂–∏–≤—ã–µ. –∏–Ω–æ–≥–¥–∞ –≤–æ–∑–º–æ–∂–Ω—ã –∑–∞–º–µ–Ω—ã –ø–æ –Ω–∞–ª–∏—á–∏—é.</div>
          </div>
        </div>

        <h3>—Å–µ—Ä–≤–∏—Å–Ω—ã–π —Å–±–æ—Ä</h3>
        <p>–µ—Å–ª–∏ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è, –æ–±—ä—è—Å–Ω—è–µ–º –ø—Ä–æ—Å—Ç–æ: —Å–±–æ—Ä–∫–∞, —É–ø–∞–∫–æ–≤–∫–∞, –ª–æ–≥–∏—Å—Ç–∏–∫–∞. –±–µ–∑ –º–∞–≥–∏–∏.</p>
      </section>

    </div>

    <nav class="bottomnav">
      <a href="#catalog" class="tab active" id="tab-catalog">‚ò∞<span>–∫–∞—Ç–∞–ª–æ–≥</span></a>
      <a href="#cart" class="tab" id="tab-cart">
        üõí<span>–∫–æ—Ä–∑–∏–Ω–∞</span>
        <div class="badge hidden" id="cartBadge">0</div>
      </a>
      <a href="#profile" class="tab" id="tab-profile">üë§<span>–ø—Ä–æ—Ñ–∏–ª—å</span></a>
      <a href="#how" class="tab" id="tab-how">‚ú≥Ô∏è<span>–∫–∞–∫</span></a>
    </nav>
  </div>

  <script>
    // Telegram init
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }

    // Close
    document.getElementById("closeBtn").onclick = () => tg?.close();

    // Profile data from Telegram
    const user = tg?.initDataUnsafe?.user;
    if (user) {
      const full = [user.first_name, user.last_name].filter(Boolean).join(" ").trim();
      document.getElementById("username").textContent = full || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
      if (user.photo_url) {
        document.getElementById("avatar").innerHTML = `<img src="${user.photo_url}" alt="avatar">`;
      } else {
        // fallback initials
        const ini = (user.first_name || "N").slice(0,1) + (user.last_name || "B").slice(0,1);
        document.getElementById("avatar").textContent = ini.toUpperCase();
      }
    }

    // Data (placeholders)
    const CATEGORIES = ["–í—Å–µ","–û—Ö–∞–ø–∫–∏","–°–µ—Ç—ã","–ó–µ–ª–µ–Ω—å","–≠–∫–∑–æ—Ç–∏–∫–∞","–°–µ–∑–æ–Ω–Ω–æ–µ"];
    const TAGS = ["–°–µ–≥–æ–¥–Ω—è","–ó–∞–≤—Ç—Ä–∞","–°—Ç–æ–π–∫–∏–µ","–ê—Ä–æ–º–∞—Ç–Ω—ã–µ","–ù–µ-—Å–∫—Ä–æ–º–Ω—ã–µ"];

    const PRODUCTS = Array.from({length: 12}).map((_, i) => ({
      id: "p" + (i + 1),
      title: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ " + (i + 1),
      price: 1500 + i * 220,
      cat: CATEGORIES[1 + (i % (CATEGORIES.length - 1))],
      tags: (i % 3 === 0) ? ["–°–µ–≥–æ–¥–Ω—è","–ù–µ-—Å–∫—Ä–æ–º–Ω—ã–µ"] : (i % 3 === 1) ? ["–ó–∞–≤—Ç—Ä–∞","–°—Ç–æ–π–∫–∏–µ"] : ["–ó–∞–≤—Ç—Ä–∞","–ê—Ä–æ–º–∞—Ç–Ω—ã–µ"],
      delivery: (i % 3 === 0) ? "–°–µ–≥–æ–¥–Ω—è" : "–ó–∞–≤—Ç—Ä–∞",
      ph: (i + 1)
    }));

    // Cart storage
    const CART_KEY = "nebuket_cart";
    const cart = JSON.parse(localStorage.getItem(CART_KEY) || "{}");
    const saveCart = () => localStorage.setItem(CART_KEY, JSON.stringify(cart));

    const $ = (id) => document.getElementById(id);

    // Navigation
    const pages = {
      catalog: $("page-catalog"),
      cart: $("page-cart"),
      profile: $("page-profile"),
      how: $("page-how")
    };
    const tabs = {
      catalog: $("tab-catalog"),
      cart: $("tab-cart"),
      profile: $("tab-profile"),
      how: $("tab-how")
    };

    function showPage(name){
      Object.keys(pages).forEach(k => pages[k].classList.toggle("hidden", k !== name));
      Object.keys(tabs).forEach(k => tabs[k].classList.toggle("active", k === name));
      location.hash = name;

      // optional: adjust MainButton
      syncMainButton();
    }

    Object.keys(tabs).forEach(key => {
      tabs[key].addEventListener("click", (e) => {
        e.preventDefault();
        showPage(key);
      });
    });

    $("goCatalog").onclick = () => showPage("catalog");

    // Filter state
    const state = { cat:"–í—Å–µ", tag:null };

    function qtyOf(id){ return cart[id] || 0; }
    function cartCount(){ return Object.values(cart).reduce((a,b) => a+b, 0); }
    function cartTotal(){
      let sum = 0;
      for (const [id, qty] of Object.entries(cart)) {
        const p = PRODUCTS.find(x => x.id === id);
        if (p) sum += p.price * qty;
      }
      return sum;
    }

    function renderBadge(){
      const n = cartCount();
      $("cartBadge").textContent = String(n);
      $("cartBadge").classList.toggle("hidden", n === 0);
    }

    function renderChips(){
      $("cats").innerHTML = CATEGORIES.map(c =>
        `<button class="chip ${state.cat===c ? "on":""}" data-cat="${c}">${c}</button>`
      ).join("");

      $("tags").innerHTML = TAGS.map(t =>
        `<button class="chip small ${state.tag===t ? "on":""}" data-tag="${t}">${t}</button>`
      ).join("");

      $("cats").onclick = (e) => {
        const b = e.target.closest("button"); if(!b) return;
        state.cat = b.dataset.cat;
        render();
      };
      $("tags").onclick = (e) => {
        const b = e.target.closest("button"); if(!b) return;
        state.tag = (state.tag === b.dataset.tag) ? null : b.dataset.tag;
        render();
      };
    }

    function renderGrid(){
      const list = PRODUCTS.filter(p => {
        const okCat = state.cat === "–í—Å–µ" || p.cat === state.cat;
        const okTag = !state.tag || p.tags.includes(state.tag);
        return okCat && okTag;
      });

      $("grid").innerHTML = list.map(p => `
        <div class="card">
          <div class="img">
            <div class="tag ${p.delivery==="–°–µ–≥–æ–¥–Ω—è" ? "red":""}">${p.delivery}</div>
            <div class="ph">${p.ph}</div>
            <div class="cornerSlash" aria-hidden="true"></div>
            <button class="cartBtn" data-open-cart="1" title="–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É">üõí</button>
          </div>
          <div class="body">
            <div class="title">${p.title}</div>
            <div class="row">
              <div class="price">${p.price.toLocaleString("ru-RU")} ‚ÇΩ</div>
              <div class="qty">
                <button data-dec="${p.id}" ${qtyOf(p.id)===0 ? "disabled":""}>‚Äì</button>
                <span>${qtyOf(p.id)}</span>
                <button data-inc="${p.id}">+</button>
              </div>
            </div>
          </div>
        </div>
      `).join("");

      $("grid").onclick = (e) => {
        const open = e.target.closest("[data-open-cart]");
        if (open) { showPage("cart"); return; }

        const btn = e.target.closest("button");
        if (!btn) return;

        const inc = btn.dataset.inc;
        const dec = btn.dataset.dec;

        if (inc) {
          cart[inc] = (cart[inc] || 0) + 1;
          saveCart();
          render();
        }
        if (dec) {
          cart[dec] = (cart[dec] || 0) - 1;
          if (cart[dec] <= 0) delete cart[dec];
          saveCart();
          render();
        }
      };
    }

    function renderCart(){
      const empty = Object.keys(cart).length === 0;
      $("cartEmpty").classList.toggle("hidden", !empty);
      $("cartFilled").classList.toggle("hidden", empty);
      if (empty) return;

      $("cartList").innerHTML = Object.entries(cart).map(([id, qty]) => {
        const p = PRODUCTS.find(x => x.id === id);
        if (!p) return "";
        return `
          <div class="cartItem">
            <div class="cartLeft">
              <div class="cartName">${p.title}</div>
              <div class="cartMeta">${p.price.toLocaleString("ru-RU")} ‚ÇΩ ‚Ä¢ ${p.cat}</div>
            </div>
            <div class="qty">
              <button data-dec="${p.id}">‚Äì</button>
              <span>${qty}</span>
              <button data-inc="${p.id}">+</button>
            </div>
          </div>
        `;
      }).join("");

      $("cartTotal").textContent = "–∏—Ç–æ–≥–æ: " + cartTotal().toLocaleString("ru-RU") + " ‚ÇΩ";

      $("cartList").onclick = (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const inc = btn.dataset.inc;
        const dec = btn.dataset.dec;

        if (inc) { cart[inc] = (cart[inc] || 0) + 1; saveCart(); render(); }
        if (dec) {
          cart[dec] = (cart[dec] || 0) - 1;
          if (cart[dec] <= 0) delete cart[dec];
          saveCart(); render();
        }
      };

      $("clearCart").onclick = () => {
        Object.keys(cart).forEach(k => delete cart[k]);
        saveCart();
        render();
      };

      $("checkoutBtn").onclick = () => {
        // –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞: –æ—Ç–ø—Ä–∞–≤–∏–º –≤ –±–æ—Ç–∞ —Å–æ—Å—Ç–∞–≤ –∑–∞–∫–∞–∑–∞
        const payload = {
          action: "checkout_preview",
          total: cartTotal(),
          items: Object.entries(cart).map(([id, qty]) => {
            const p = PRODUCTS.find(x => x.id === id);
            return { id, title: p?.title, price: p?.price, qty };
          })
        };
        tg?.sendData(JSON.stringify(payload));
        alert("–ó–∞–≥–ª—É—à–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è.\n–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –±–æ—Ç–∞ (–µ—Å–ª–∏ –æ–Ω —Å–ª—É—à–∞–µ—Ç web_app_data).");
      };
    }

    function syncMainButton(){
      // –ù–µ –æ–±—è–∑–∞–ª–æ–≤–∫–∞, –Ω–æ –≤—ã–≥–ª—è–¥–∏—Ç ‚Äú–ø–æ-–≤–∑—Ä–æ—Å–ª–æ–º—É‚Äù
      if (!tg?.MainButton) return;

      const has = cartCount() > 0;
      if (!has) { tg.MainButton.hide(); return; }

      const total = cartTotal().toLocaleString("ru-RU") + " ‚ÇΩ";
      tg.MainButton.setText("–û—Ñ–æ—Ä–º–∏—Ç—å ‚Ä¢ " + total);
      tg.MainButton.show();

      tg.MainButton.onClick(() => {
        showPage("cart");
      });
    }

    function render(){
      renderChips();
      renderGrid();
      renderCart();
      renderBadge();
      syncMainButton();
    }

    // initial
    const start = (location.hash || "#catalog").replace("#","");
    showPage(["catalog","cart","profile","how"].includes(start) ? start : "catalog");
    render();
  </script>
</body>
</html>
