<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ne buket</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --mint:#A7CEBB;
      --ink:#060A07;
      --red:#DF3A2C;
      --soft:#F6F6F6;
      --line:#EAEAEA;
      --muted:#6E6E6E;
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#fff;
      color:var(--ink);
    }

    .app{min-height:100vh; padding-bottom:78px;}
    .content{padding:14px 14px 24px;}
    .hidden{display:none !important;}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:var(--mint);
      padding:14px 12px 12px;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .topbar-grid{
      display:grid;
      grid-template-columns: 88px 1fr 44px;
      align-items:center;
      gap:8px;
    }
    .ghost{
      background:transparent;
      border:0;
      font-size:16px;
      color:var(--ink);
      padding:8px 10px;
      border-radius:12px;
    }
    .ghost:active{background:rgba(255,255,255,.25)}
    .brandwrap{ text-align:center; }
    .brand{
      font-weight:900;
      letter-spacing:-.6px;
      font-size:20px;
      text-transform:none;
    }

    /* Bottom nav */
    .bottomnav{
      position:fixed; left:0; right:0; bottom:0; z-index:60;
      background:#fff;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:space-around;
      padding:10px 8px 12px;
    }
    .tab{
      width:25%;
      text-decoration:none;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      font-size:18px;
      padding:6px 0;
      position:relative;
      user-select:none;
    }
    .tab span{font-size:12px; font-weight:700}
    .tab.active{color:var(--ink)}
    .tab.active::after{
      content:"";
      position:absolute;
      bottom:2px;
      width:36px;
      height:4px;
      background:var(--red);
      border-radius:999px;
      transform:rotate(-10deg);
    }
    .badge{
      position:absolute;
      top:2px;
      right:28%;
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      background:var(--ink);
      color:#fff;
      font-size:12px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      transform:translate(10px,-6px);
    }
    .badge.hidden{display:none}

    /* Catalog header */
    .catalogHead{
      margin:10px 0 10px;
      padding:14px;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:#fff;
    }
    .catalogHead .big{
      margin:0;
      font-size:34px;
      font-weight:950;
      letter-spacing:-1.2px;
      text-transform:none;
    }
    .strikeLine{
      margin-top:10px;
      display:inline-block;
      position:relative;
      font-size:18px;
      font-weight:500;
      letter-spacing:-.4px;
      text-transform:none;
      padding:4px 2px;
    }
    /* ‚Äú–∫–∏—Å—Ç–µ–≤–æ–π‚Äù —Å–ª—ç—à –ø–æ–≤–µ—Ä—Ö —Å–ª–æ–≤–∞ */
    .strikeLine::after{
      content:"";
      position:absolute;
      left:-8%;
      top:52%;
      width:116%;
      height:18px;
      transform:rotate(-14deg);
      opacity:.95;
      pointer-events:none;

      /* SVG –º–∞–∑–æ–∫ –∫–∏—Å—Ç–∏ (data URI) */
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='80' viewBox='0 0 600 80'%3E%3Cpath d='M20 50 C80 15 140 70 210 40 C290 5 350 75 430 36 C500 2 540 55 580 28' fill='none' stroke='%23DF3A2C' stroke-width='18' stroke-linecap='round' stroke-linejoin='round' opacity='0.95'/%3E%3Cpath d='M25 54 C90 24 145 68 215 44 C290 18 355 68 435 40 C505 16 545 56 575 34' fill='none' stroke='%23DF3A2C' stroke-width='10' stroke-linecap='round' stroke-linejoin='round' opacity='0.55'/%3E%3C/svg%3E") no-repeat center;
      background-size:100% 100%;
      filter:saturate(1.05);
    }

    /* Chips (filters only) */
    .chips{
      display:flex;
      gap:8px;
      overflow:auto;
      padding:2px 0 8px;
    }
    .chip{
      flex:0 0 auto;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.16);
      background:#fff;
      color:var(--ink);
      font-weight:700;
      font-size:13px;
      user-select:none;
    }
    .chip.on{
      border-color:var(--ink);
      box-shadow: inset 0 0 0 1px var(--ink);
      font-weight:800;
    }

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:8px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:#fff;
    }
    .img{
      position:relative;
      aspect-ratio:1/1;
      background:linear-gradient(135deg, #fafafa, #eaeaea);
    }
    .img .ph{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:38px;
      font-weight:950;
      color:rgba(0,0,0,.70);
      letter-spacing:-2px;
      user-select:none;
    }
    .img .cornerBrush{
      position:absolute;
      right:-26px;
      bottom:18px;
      width:100px;
      height:16px;
      transform:rotate(-22deg);
      opacity:.92;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='60' viewBox='0 0 240 60'%3E%3Cpath d='M10 35 C40 10 70 52 100 30 C140 2 170 52 210 18' fill='none' stroke='%23DF3A2C' stroke-width='14' stroke-linecap='round' stroke-linejoin='round' opacity='0.9'/%3E%3C/svg%3E") no-repeat center;
      background-size:100% 100%;
    }
    .img .cartBtn{
      position:absolute;
      right:10px;
      bottom:10px;
      width:36px;
      height:36px;
      border-radius:50%;
      border:0;
      background:rgba(0,0,0,.55);
      color:#fff;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .img .cartBtn:active{transform:scale(.96)}

    .body{padding:10px 10px 12px}
    /* —Ç–æ–Ω—å—à–µ –∏ –ª–µ–≥—á–µ */
    .title{
      font-weight:400;
      font-size:14px;
      letter-spacing:-.2px;
      margin:0 0 8px;
      color:var(--ink);
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .price{
      font-weight:400;
      font-size:14px;
      letter-spacing:-.2px;
      color:var(--ink);
    }
    .qty{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
    }
    .qty button{
      width:28px;height:28px;
      border-radius:50%;
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      font-size:18px;
      cursor:pointer;
    }
    .qty button:disabled{opacity:.35; cursor:default}
    .qty span{min-width:18px; text-align:center}

    /* Cart */
    .h2{
      font-size:22px;
      font-weight:900;
      letter-spacing:-.6px;
      margin:6px 0 12px;
      text-transform:none;
    }

    .empty{
      min-height:58vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .panel{
      width:min(420px, 100%);
      background:var(--soft);
      border:1px solid var(--line);
      border-radius:22px;
      padding:22px;
      text-align:center;
    }
    .panel .t{
      font-size:20px;
      font-weight:900;
      margin-bottom:8px;
    }
    .panel .p{
      color:var(--muted);
      font-weight:600;
      margin-bottom:14px;
      line-height:1.25;
    }
    .btn{
      width:80%;
      padding:14px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .btn.red{
      border-color:var(--red);
      color:#fff;
      background:var(--red);
    }
    .btn:active{transform:scale(.99)}

    .cartList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .cartItem{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:#fff;
    }
    .cartLeft{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .cartName{
      font-weight:700;
      letter-spacing:-.2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:220px;
    }
    .cartMeta{
      color:var(--muted);
      font-weight:600;
      font-size:13px;
    }
    .bar{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .total{
      font-weight:900;
      font-size:16px;
    }
    .clear{
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }

    /* Profile */
    .profileTop{
      display:flex;
      align-items:center;
      gap:12px;
      margin:8px 0 14px;
    }
    .avatar{
      width:54px;height:54px;
      border-radius:50%;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.10);
      background:linear-gradient(135deg, #fafafa, #e6e6e6);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .name{
      font-size:22px;
      font-weight:900;
      letter-spacing:-.5px;
      line-height:1.05;
    }
    .box{
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--soft);
      padding:14px;
      margin-bottom:12px;
    }
    .box .bh{
      font-weight:900;
      margin-bottom:6px;
    }
    .linkBtn{
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin:12px 0 18px;
    }
    .item{
      font-weight:800;
      font-size:16px;
    }
    .subitem{
      margin-top:6px;
      color:var(--muted);
      font-weight:600;
      font-size:13px;
    }

    /* Simple modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:flex;
      align-items:flex-end;
      justify-content:center;
      z-index:200;
      padding:12px;
    }
    .sheet{
      width:min(560px, 100%);
      background:#fff;
      border-radius:22px;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .sheetHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:var(--mint);
      position:relative;
    }
    .sheetTitle{
      font-weight:900;
      font-size:16px;
      letter-spacing:-.2px;
    }
    .xbtn{
      border:0;
      background:rgba(255,255,255,.35);
      width:34px;height:34px;
      border-radius:12px;
      font-size:18px;
      cursor:pointer;
    }
    .sheetBody{
      padding:14px;
    }
    .field{
      margin-bottom:12px;
    }
    label{
      display:block;
      font-weight:800;
      font-size:13px;
      margin-bottom:6px;
    }
    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.14);
      font-size:16px;
      outline:none;
    }
    input:focus{border-color:rgba(0,0,0,.35)}
    .err{
      margin-top:6px;
      color:var(--red);
      font-weight:700;
      font-size:12px;
      display:none;
    }
    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .radioRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .radio{
      border:1px solid rgba(0,0,0,.14);
      border-radius:999px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      background:#fff;
      user-select:none;
    }
    .radio.on{
      border-color:var(--ink);
      box-shadow: inset 0 0 0 1px var(--ink);
    }
    .checkRow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:8px;
      font-weight:800;
      color:var(--muted);
    }
    .checkRow input{width:auto}
    .sheetFoot{
      padding:12px 14px 16px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:center;
      background:#fff;
    }
    .note{
      margin-top:8px;
      color:var(--muted);
      font-weight:600;
      font-size:12px;
      line-height:1.25;
    }

    /* Order details list in modal */
    .miniList{
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      margin-top:10px;
    }
    .miniRow{
      padding:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      border-top:1px solid var(--line);
      background:#fff;
    }
    .miniRow:first-child{border-top:0}
    .miniRow b{font-weight:900}
    .miniRow span{color:var(--muted); font-weight:600}

    @media (max-width:360px){
      .grid{grid-template-columns:1fr}
      .cartName{max-width:160px}
      .row2{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="topbar-grid">
        <button class="ghost" id="closeBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
        <div class="brandwrap">
          <div class="brand">Ne buket</div>
        </div>
        <button class="ghost" aria-label="menu">‚ãØ</button>
      </div>
    </div>

    <div class="content">

      <!-- CATALOG -->
      <section id="page-catalog">
        <div class="catalogHead">
          <h1 class="big">Ne buket</h1>
          <div class="strikeLine">Ne buket</div>
        </div>

        <div class="chips" id="cats"></div>
        <div class="grid" id="grid"></div>
      </section>

      <!-- CART -->
      <section id="page-cart" class="hidden">
        <div class="h2">–ö–æ—Ä–∑–∏–Ω–∞</div>

        <div id="cartEmpty" class="empty">
          <div class="panel">
            <div class="t">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è</div>
            <div class="p">–ù–∞–∂–º–∏ ‚Äú+‚Äù —É —Ç–æ–≤–∞—Ä–∞. –û–Ω –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.</div>
            <button class="btn red" id="goCatalog">–í –∫–∞—Ç–∞–ª–æ–≥</button>
          </div>
        </div>

        <div id="cartFilled" class="hidden">
          <div class="cartList" id="cartList"></div>

          <div class="bar">
            <div class="total" id="cartTotal">–ò—Ç–æ–≥–æ: 0 ‚ÇΩ</div>
            <button class="clear" id="clearCart">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>

          <div style="margin-top:12px; display:flex; justify-content:center;">
            <button class="btn red" id="checkoutBtn">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
          </div>
        </div>
      </section>

      <!-- PROFILE -->
      <section id="page-profile" class="hidden">
        <div class="profileTop">
          <div class="avatar" id="avatar">NB</div>
          <div>
            <div class="name" id="username">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
          </div>
        </div>

        <div class="box" id="activeBox">
          <div class="bh">–ê–∫—Ç–∏–≤–Ω—ã–π –∑–∞–∫–∞–∑</div>
          <div id="activeText" style="color:var(--muted); font-weight:600;">–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
          <div style="margin-top:10px; display:none;" id="activeActions">
            <button class="linkBtn" id="openActive">–û—Ç–∫—Ä—ã—Ç—å</button>
          </div>
        </div>

        <div class="list">
          <div class="item">
            üìç –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏
            <div class="subitem" id="lastAddress">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
          </div>

          <div class="item" id="historyBtn">
            üßæ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤
            <div class="subitem">–ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ (–±—É–¥—É—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏)</div>
          </div>
        </div>
      </section>

      <!-- HOW (–æ—Å—Ç–∞–≤–∏–ª, –≤–¥—Ä—É–≥ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è) -->
      <section id="page-how" class="hidden">
        <div class="h2">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
        <div class="panel" style="text-align:left">
          <div class="p" style="margin:0">
            –ó–¥–µ—Å—å –ø–æ–∑–∂–µ –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞: —Å—Ä–æ–∫–∏, –∑–∞–º–µ–Ω—ã, —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç–∞–≤–∫–∏/—Å–∞–º–æ–≤—ã–≤–æ–∑–∞.
          </div>
        </div>
      </section>

    </div>

    <nav class="bottomnav">
      <a href="#catalog" class="tab active" id="tab-catalog">‚ò∞<span>–ö–∞—Ç–∞–ª–æ–≥</span></a>
      <a href="#cart" class="tab" id="tab-cart">
        üõí<span>–ö–æ—Ä–∑–∏–Ω–∞</span>
        <div class="badge hidden" id="cartBadge">0</div>
      </a>
      <a href="#profile" class="tab" id="tab-profile">üë§<span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
      <a href="#how" class="tab" id="tab-how">‚ú≥Ô∏è<span>–ö–∞–∫</span></a>
    </nav>
  </div>

  <!-- CHECKOUT MODAL -->
  <div class="modal hidden" id="checkoutModal">
    <div class="sheet">
      <div class="sheetHead">
        <div class="sheetTitle" id="checkoutTitle">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</div>
        <button class="xbtn" id="closeCheckout">‚úï</button>
      </div>

      <div class="sheetBody" id="checkoutFormView">
        <div class="field">
          <label for="cName">–ò–º—è</label>
          <input id="cName" placeholder="–ò–≤–∞–Ω" />
          <div class="err" id="eName"></div>
        </div>

        <div class="field">
          <label for="cPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="cPhone" inputmode="numeric" placeholder="+7 (___) ___-__-__" />
          <div class="err" id="ePhone"></div>
          <div class="note">–í–≤–æ–¥–∏ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã, —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è —Å–∞–º.</div>
        </div>

        <div class="field">
          <label>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</label>
          <div class="radioRow">
            <div class="radio on" id="optDelivery" data-mode="delivery">–î–æ—Å—Ç–∞–≤–∫–∞</div>
            <div class="radio" id="optPickup" data-mode="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</div>
          </div>
          <div class="err" id="eMode"></div>
        </div>

        <div id="addrBlock">
          <div class="field">
            <label for="cStreet">–£–ª–∏—Ü–∞</label>
            <input id="cStreet" placeholder="–õ–µ–Ω–∏–Ω–∞" />
            <div class="err" id="eStreet"></div>
          </div>

          <div class="row2">
            <div class="field">
              <label for="cHouse">–î–æ–º</label>
              <input id="cHouse" placeholder="10" />
              <div class="err" id="eHouse"></div>
            </div>

            <div class="field" id="aptField">
              <label for="cApt">–ö–≤–∞—Ä—Ç–∏—Ä–∞</label>
              <input id="cApt" placeholder="25" />
              <div class="err" id="eApt"></div>
              <div class="checkRow">
                <input type="checkbox" id="noApt" />
                <label for="noApt" style="margin:0; font-weight:800; font-size:13px; cursor:pointer;">–ù–µ—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã</label>
              </div>
            </div>
          </div>
        </div>

        <div class="sheetFoot">
          <button class="btn red" id="sendToWork">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
        </div>
      </div>

      <div class="sheetBody hidden" id="checkoutSuccessView">
        <div style="font-weight:900; font-size:18px; margin-bottom:8px;">
          –í–∞—à –∑–∞–∫–∞–∑ —É–∂–µ –≤ —Ä–∞–±–æ—Ç–µ
        </div>
        <div style="color:var(--muted); font-weight:600; line-height:1.3;">
          –ú—ã —Å–ø–µ—à–∏–º –ø–æ–∑–≤–æ–Ω–∏—Ç—å –í–∞–º –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞.
        </div>
        <div class="sheetFoot" style="border-top:0; padding-top:16px;">
          <button class="btn red" id="okSuccess">–û–∫</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ORDER DETAILS MODAL -->
  <div class="modal hidden" id="orderModal">
    <div class="sheet">
      <div class="sheetHead">
        <div class="sheetTitle" id="orderTitle">–ó–∞–∫–∞–∑</div>
        <button class="xbtn" id="closeOrder">‚úï</button>
      </div>
      <div class="sheetBody" id="orderBody"></div>
    </div>
  </div>

  <script>
    // Telegram init
    const tg = window.Telegram?.WebApp;
    if (tg) { tg.ready(); tg.expand(); }
    document.getElementById("closeBtn").onclick = () => tg?.close();

    // Profile data from Telegram
    const user = tg?.initDataUnsafe?.user;
    if (user) {
      const full = [user.first_name, user.last_name].filter(Boolean).join(" ").trim();
      document.getElementById("username").textContent = full || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å";
      if (user.photo_url) {
        document.getElementById("avatar").innerHTML = `<img src="${user.photo_url}" alt="avatar">`;
      } else {
        const ini = (user.first_name || "N").slice(0,1) + (user.last_name || "B").slice(0,1);
        document.getElementById("avatar").textContent = ini.toUpperCase();
      }
    }

    // Data
    const CATEGORIES = ["–í—Å–µ","–û—Ö–∞–ø–∫–∏","–°–µ—Ç—ã","–ó–µ–ª–µ–Ω—å","–≠–∫–∑–æ—Ç–∏–∫–∞","–°–µ–∑–æ–Ω–Ω–æ–µ"];

    const PRODUCTS = Array.from({length: 12}).map((_, i) => ({
      id: "p" + (i + 1),
      title: "–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ " + (i + 1),
      price: 1500 + i * 220,
      cat: CATEGORIES[1 + (i % (CATEGORIES.length - 1))],
      ph: (i + 1)
    }));

    // Storage keys
    const CART_KEY = "nebuket_cart";
    const ORDERS_KEY = "nebuket_orders";
    const ACTIVE_KEY = "nebuket_active_order_id";

    const cart = JSON.parse(localStorage.getItem(CART_KEY) || "{}");
    const orders = JSON.parse(localStorage.getItem(ORDERS_KEY) || "[]");
    let activeOrderId = localStorage.getItem(ACTIVE_KEY) || "";

    const saveCart = () => localStorage.setItem(CART_KEY, JSON.stringify(cart));
    const saveOrders = () => localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
    const saveActive = () => localStorage.setItem(ACTIVE_KEY, activeOrderId);

    const $ = (id) => document.getElementById(id);

    // Navigation
    const pages = {
      catalog: $("page-catalog"),
      cart: $("page-cart"),
      profile: $("page-profile"),
      how: $("page-how")
    };
    const tabs = {
      catalog: $("tab-catalog"),
      cart: $("tab-cart"),
      profile: $("tab-profile"),
      how: $("tab-how")
    };
    function showPage(name){
      Object.keys(pages).forEach(k => pages[k].classList.toggle("hidden", k !== name));
      Object.keys(tabs).forEach(k => tabs[k].classList.toggle("active", k === name));
      location.hash = name;
    }
    Object.keys(tabs).forEach(key => {
      tabs[key].addEventListener("click", (e) => {
        e.preventDefault();
        showPage(key);
      });
    });
    $("goCatalog").onclick = () => showPage("catalog");

    // Filters
    const state = { cat:"–í—Å–µ" };

    function qtyOf(id){ return cart[id] || 0; }
    function cartCount(){ return Object.values(cart).reduce((a,b) => a+b, 0); }
    function cartTotal(){
      let sum = 0;
      for (const [id, qty] of Object.entries(cart)) {
        const p = PRODUCTS.find(x => x.id === id);
        if (p) sum += p.price * qty;
      }
      return sum;
    }

    function renderBadge(){
      const n = cartCount();
      $("cartBadge").textContent = String(n);
      $("cartBadge").classList.toggle("hidden", n === 0);
    }

    function renderChips(){
      $("cats").innerHTML = CATEGORIES.map(c =>
        `<button class="chip ${state.cat===c ? "on":""}" data-cat="${c}">${c}</button>`
      ).join("");

      $("cats").onclick = (e) => {
        const b = e.target.closest("button"); if(!b) return;
        state.cat = b.dataset.cat;
        render();
      };
    }

    function renderGrid(){
      const list = PRODUCTS.filter(p => state.cat === "–í—Å–µ" || p.cat === state.cat);

      $("grid").innerHTML = list.map(p => `
        <div class="card">
          <div class="img">
            <div class="ph">${p.ph}</div>
            <div class="cornerBrush" aria-hidden="true"></div>
            <button class="cartBtn" data-open-cart="1" title="–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É">üõí</button>
          </div>
          <div class="body">
            <div class="title">${p.title}</div>
            <div class="row">
              <div class="price">${p.price.toLocaleString("ru-RU")} ‚ÇΩ</div>
              <div class="qty">
                <button data-dec="${p.id}" ${qtyOf(p.id)===0 ? "disabled":""}>‚Äì</button>
                <span>${qtyOf(p.id)}</span>
                <button data-inc="${p.id}">+</button>
              </div>
            </div>
          </div>
        </div>
      `).join("");

      $("grid").onclick = (e) => {
        const open = e.target.closest("[data-open-cart]");
        if (open) { showPage("cart"); return; }

        const btn = e.target.closest("button");
        if (!btn) return;

        const inc = btn.dataset.inc;
        const dec = btn.dataset.dec;

        if (inc) {
          cart[inc] = (cart[inc] || 0) + 1;
          saveCart();
          render();
        }
        if (dec) {
          cart[dec] = (cart[dec] || 0) - 1;
          if (cart[dec] <= 0) delete cart[dec];
          saveCart();
          render();
        }
      };
    }

    function renderCart(){
      const empty = Object.keys(cart).length === 0;
      $("cartEmpty").classList.toggle("hidden", !empty);
      $("cartFilled").classList.toggle("hidden", empty);
      if (empty) return;

      $("cartList").innerHTML = Object.entries(cart).map(([id, qty]) => {
        const p = PRODUCTS.find(x => x.id === id);
        if (!p) return "";
        return `
          <div class="cartItem">
            <div class="cartLeft">
              <div class="cartName">${p.title}</div>
              <div class="cartMeta">${p.price.toLocaleString("ru-RU")} ‚ÇΩ ‚Ä¢ ${p.cat}</div>
            </div>
            <div class="qty">
              <button data-dec="${p.id}">‚Äì</button>
              <span>${qty}</span>
              <button data-inc="${p.id}">+</button>
            </div>
          </div>
        `;
      }).join("");

      $("cartTotal").textContent = "–ò—Ç–æ–≥–æ: " + cartTotal().toLocaleString("ru-RU") + " ‚ÇΩ";

      $("cartList").onclick = (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        const inc = btn.dataset.inc;
        const dec = btn.dataset.dec;

        if (inc) { cart[inc] = (cart[inc] || 0) + 1; saveCart(); render(); }
        if (dec) {
          cart[dec] = (cart[dec] || 0) - 1;
          if (cart[dec] <= 0) delete cart[dec];
          saveCart(); render();
        }
      };

      $("clearCart").onclick = () => {
        Object.keys(cart).forEach(k => delete cart[k]);
        saveCart();
        render();
      };
    }

    // ===== Checkout modal + validation =====
    const checkoutModal = $("checkoutModal");
    const checkoutFormView = $("checkoutFormView");
    const checkoutSuccessView = $("checkoutSuccessView");

    const cName = $("cName");
    const cPhone = $("cPhone");
    const optDelivery = $("optDelivery");
    const optPickup = $("optPickup");
    const addrBlock = $("addrBlock");
    const cStreet = $("cStreet");
    const cHouse = $("cHouse");
    const cApt = $("cApt");
    const noApt = $("noApt");

    let mode = "delivery"; // default

    function openModal(el){ el.classList.remove("hidden"); }
    function closeModal(el){ el.classList.add("hidden"); }

    function clearErrors(){
      ["eName","ePhone","eMode","eStreet","eHouse","eApt"].forEach(id => {
        const e = $(id);
        e.style.display = "none";
        e.textContent = "";
      });
    }
    function setError(id, msg){
      const e = $(id);
      e.textContent = msg;
      e.style.display = "block";
    }

    function formatPhone(raw){
      // keep digits only
      let d = (raw || "").replace(/\D/g, "");
      // allow user to type starting with 7/8/9 etc, we normalize to +7 + 10 digits
      if (d.startsWith("8")) d = "7" + d.slice(1);
      if (d.startsWith("9")) d = "7" + d;
      if (!d.startsWith("7")) d = "7" + d;
      d = d.slice(0, 11); // 7 + 10 digits

      const a = d.slice(1, 4);
      const b = d.slice(4, 7);
      const c = d.slice(7, 9);
      const e = d.slice(9, 11);

      let out = "+7";
      if (a.length) out += " (" + a;
      if (a.length === 3) out += ")";
      if (b.length) out += " " + b;
      if (c.length) out += "-" + c;
      if (e.length) out += "-" + e;

      return { formatted: out, digits: d };
    }

    cPhone.addEventListener("input", () => {
      const f = formatPhone(cPhone.value);
      cPhone.value = f.formatted;
    });

    function setMode(m){
      mode = m;
      optDelivery.classList.toggle("on", m === "delivery");
      optPickup.classList.toggle("on", m === "pickup");
      addrBlock.classList.toggle("hidden", m !== "delivery");
    }
    optDelivery.onclick = () => setMode("delivery");
    optPickup.onclick = () => setMode("pickup");

    noApt.addEventListener("change", () => {
      if (noApt.checked) {
        cApt.value = "";
        cApt.disabled = true;
      } else {
        cApt.disabled = false;
      }
    });

    $("checkoutBtn").onclick = () => {
      clearErrors();
      checkoutFormView.classList.remove("hidden");
      checkoutSuccessView.classList.add("hidden");
      setMode(mode || "delivery");
      openModal(checkoutModal);
    };

    $("closeCheckout").onclick = () => closeModal(checkoutModal);
    $("okSuccess").onclick = () => {
      closeModal(checkoutModal);
      showPage("profile");
    };

    function genOrderId(){
      return String(Date.now()).slice(-6); // –ø—Ä–æ—Å—Ç–æ–π, –Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
    }

    function validateCheckout(){
      clearErrors();

      const name = (cName.value || "").trim();
      const phoneInfo = formatPhone(cPhone.value);
      const phoneDigits = phoneInfo.digits; // 11 digits, starts with 7

      if (!name) setError("eName", "–£–∫–∞–∂–∏—Ç–µ –∏–º—è");
      if (phoneDigits.length !== 11) setError("ePhone", "–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é");

      if (mode !== "delivery" && mode !== "pickup") setError("eMode", "–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è");

      if (mode === "delivery") {
        const street = (cStreet.value || "").trim();
        const house = (cHouse.value || "").trim();
        const apt = (cApt.value || "").trim();

        if (!street) setError("eStreet", "–£–∫–∞–∂–∏—Ç–µ —É–ª–∏—Ü—É");
        if (!house) setError("eHouse", "–£–∫–∞–∂–∏—Ç–µ –¥–æ–º");
        if (!noApt.checked && !apt) setError("eApt", "–£–∫–∞–∂–∏—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—É –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ ‚Äú–ù–µ—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã‚Äù");
      }

      // any errors visible?
      const any = ["eName","ePhone","eMode","eStreet","eHouse","eApt"].some(id => $(id).style.display === "block");
      if (any) return null;

      // Build address
      let address = "–°–∞–º–æ–≤—ã–≤–æ–∑";
      if (mode === "delivery") {
        const street = (cStreet.value || "").trim();
        const house = (cHouse.value || "").trim();
        const apt = noApt.checked ? "" : (cApt.value || "").trim();
        address = `${street}, –¥–æ–º ${house}` + (apt ? `, –∫–≤ ${apt}` : "");
      }

      return {
        customer_name: name,
        customer_phone: phoneInfo.formatted,
        mode,
        address
      };
    }

    function buildOrderItems(){
      return Object.entries(cart).map(([id, qty]) => {
        const p = PRODUCTS.find(x => x.id === id);
        return { id, title: p?.title || id, price: p?.price || 0, qty };
      });
    }

    $("sendToWork").onclick = () => {
      const data = validateCheckout();
      if (!data) return;

      const items = buildOrderItems();
      const total = cartTotal();
      const order = {
        id: genOrderId(),
        created_at: new Date().toISOString(),
        status: "in_work",
        items,
        total,
        ...data
      };

      orders.unshift(order);
      saveOrders();

      activeOrderId = order.id;
      saveActive();

      // –æ—á–∏—Å—Ç–∏–º –∫–æ—Ä–∑–∏–Ω—É
      Object.keys(cart).forEach(k => delete cart[k]);
      saveCart();

      // –æ—Ç–ø—Ä–∞–≤–∏–º –±–æ—Ç—É (–µ—Å–ª–∏ –æ–Ω —Å–ª—É—à–∞–µ—Ç web_app_data)
      tg?.sendData(JSON.stringify({ action:"order_in_work", order }));

      // success screen
      checkoutFormView.classList.add("hidden");
      checkoutSuccessView.classList.remove("hidden");

      render();
    };

    // ===== Order details modal =====
    const orderModal = $("orderModal");
    $("closeOrder").onclick = () => closeModal(orderModal);

    function openOrderDetails(order){
      $("orderTitle").textContent = `–ó–∞–∫–∞–∑ ‚Ññ${order.id}`;
      const itemsHtml = order.items.map(it => `
        <div class="miniRow">
          <div><b>${it.title}</b><br><span>${it.qty} √ó ${it.price.toLocaleString("ru-RU")} ‚ÇΩ</span></div>
          <div><b>${(it.qty*it.price).toLocaleString("ru-RU")} ‚ÇΩ</b></div>
        </div>
      `).join("");

      $("orderBody").innerHTML = `
        <div class="miniList">
          ${itemsHtml}
        </div>

        <div class="miniList" style="margin-top:12px">
          <div class="miniRow"><div><b>–ü–æ–ª—É—á–µ–Ω–∏–µ</b><br><span>${order.mode === "delivery" ? "–î–æ—Å—Ç–∞–≤–∫–∞" : "–°–∞–º–æ–≤—ã–≤–æ–∑"}</span></div></div>
          <div class="miniRow"><div><b>–ê–¥—Ä–µ—Å</b><br><span>${order.address}</span></div></div>
          <div class="miniRow"><div><b>–ò–º—è</b><br><span>${order.customer_name}</span></div></div>
          <div class="miniRow"><div><b>–¢–µ–ª–µ—Ñ–æ–Ω</b><br><span>${order.customer_phone}</span></div></div>
          <div class="miniRow"><div><b>–°—Ç–∞—Ç—É—Å</b><br><span>–í —Ä–∞–±–æ—Ç–µ</span></div><div><b>${order.total.toLocaleString("ru-RU")} ‚ÇΩ</b></div></div>
        </div>
      `;
      openModal(orderModal);
    }

    // Profile rendering
    function renderProfile(){
      // last address from last order
      const last = orders[0];
      $("lastAddress").textContent = last ? last.address : "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö";

      const active = orders.find(o => o.id === activeOrderId && o.status === "in_work");
      const activeText = $("activeText");
      const activeActions = $("activeActions");

      if (!active) {
        activeText.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤";
        activeActions.style.display = "none";
        return;
      }

      const count = active.items.reduce((s, it) => s + it.qty, 0);
      activeText.textContent = `‚Ññ${active.id} ‚Ä¢ ${count} —à—Ç ‚Ä¢ ${active.total.toLocaleString("ru-RU")} ‚ÇΩ`;
      activeActions.style.display = "block";

      $("openActive").onclick = () => openOrderDetails(active);
    }

    // History button (placeholder: –ø–æ–∫–∞–∂–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑)
    $("historyBtn").onclick = () => {
      if (!orders.length) {
        alert("–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –ø—É—Å—Ç–∞—è.");
        return;
      }
      openOrderDetails(orders[0]);
    };

    // Render all
    function render(){
      renderChips();
      renderGrid();
      renderCart();
      renderBadge();
      renderProfile();
    }

    // Initial page
    const start = (location.hash || "#catalog").replace("#","");
    showPage(["catalog","cart","profile","how"].includes(start) ? start : "catalog");
    render();
  </script>
</body>
</html>
